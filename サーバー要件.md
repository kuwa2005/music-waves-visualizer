# サーバー要件（レンタルサーバー・共有ホスティング用）

## 1. 概要

このドキュメントは、一般的なWebサーバー（レンタルサーバー、共有ホスティングなど）でMusic Waves Visualizerを動作させるための要件と手順を説明します。

## 2. サーバー要件

### 2.1 必須要件

#### Node.js環境
- **Node.js**: 18.x以上（推奨: 18 LTS以上）
- **npm**: 8.x以上
- **実行権限**: Node.jsコマンドの実行権限
- **ファイルアップロード**: FTP/SFTPまたはSSHでのファイルアップロード機能

#### PHP環境（静的サイトとして配信する場合）
- **PHP**: 7.4以上（静的HTMLの配信用、オプション）

#### 静的ホスティングサービス
以下のサービスも利用可能です：
- **Vercel**: Next.js推奨、無料プランあり
- **Netlify**: 静的サイトホスティング
- **GitHub Pages**: 静的サイトホスティング（要ビルド済みファイル）

### 2.2 推奨要件

#### ストレージ
- **最小**: 500MB以上の空き容量
- **推奨**: 1GB以上の空き容量

#### メモリ
- **最小**: 512MB以上の利用可能メモリ
- **推奨**: 1GB以上の利用可能メモリ

#### 帯域幅
- **最小**: 10GB/月
- **推奨**: 50GB/月以上（動画ファイルのダウンロード用）

### 2.3 必要な機能

#### Webサーバー機能
- **HTTP/HTTPS**: ポート80/443でのアクセス
- **静的ファイル配信**: HTML、CSS、JavaScript、画像ファイルの配信
- **カスタムドメイン**: 独自ドメインの設定（オプション）
- **SSL証明書**: HTTPS対応（推奨）

#### ファイル操作
- **FTP/SFTP**: ファイルのアップロード
- **SSH**: コマンドラインアクセス（推奨）
- **ファイル権限変更**: chmodコマンドの実行（オプション）

## 3. セットアップ手順

### 3.1 事前準備

#### 3.1.1 ローカル環境でのビルド

レンタルサーバーにNode.js環境がない場合、ローカルまたはCI/CD環境でビルドしてから静的ファイルをアップロードします。

1. **ローカル環境の準備**
   ```bash
   # Node.js 18.x以上をインストール
   # リポジトリをクローン
   git clone https://github.com/kuwa2005/music-waves-visualizer.git
   cd music-waves-visualizer
   ```

2. **依存関係のインストール**
   ```bash
   npm install
   ```

3. **環境変数の設定**
   `.env.production`ファイルを作成：
   ```bash
   NEXT_PUBLIC_DEVELOPER_MODE=false
   NEXT_TELEMETRY_DISABLED=1
   ```

4. **静的エクスポート用の設定**
   `next.config.js`を確認または編集：
   ```javascript
   /** @type {import('next').NextConfig} */
   const nextConfig = {
     output: 'export',  // 静的エクスポートを有効化
     reactStrictMode: true,
     // 注意: COOP/COEPヘッダーは静的エクスポートでは設定できないため、
     // SharedArrayBufferが使用できない可能性があります
   };
   module.exports = nextConfig;
   ```

5. **ビルド実行**
   ```bash
   npm run build
   ```

   ビルド後、`out`ディレクトリに静的ファイルが生成されます。

### 3.2 静的サイトとしてのデプロイ

#### 3.2.1 ファイルのアップロード

1. **FTP/SFTPクライアントを使用**
   - FileZilla、WinSCP、Cyberduckなどを使用
   - サーバーのドキュメントルート（通常は`public_html`、`www`、`htdocs`など）に接続

2. **ファイルのアップロード**
   - `out`ディレクトリ内のすべてのファイルをアップロード
   - ディレクトリ構造を維持

3. **ファイル権限の設定**
   ```bash
   # ディレクトリの権限
   chmod 755 ./
   chmod 755 _next/
   
   # ファイルの権限
   chmod 644 *.html
   chmod 644 *.js
   chmod 644 *.css
   ```

#### 3.2.2 サーバー設定

1. **.htaccessファイルの作成（Apacheの場合）**
   `public_html`ディレクトリに`.htaccess`ファイルを作成：
   ```apache
   # リライトルール（Next.jsのルーティング用）
   RewriteEngine On
   RewriteBase /
   RewriteRule ^index\.html$ - [L]
   RewriteCond %{REQUEST_FILENAME} !-f
   RewriteCond %{REQUEST_FILENAME} !-d
   RewriteRule . /index.html [L]

   # セキュリティヘッダー
   <IfModule mod_headers.c>
     Header set Cross-Origin-Opener-Policy "same-origin"
     Header set Cross-Origin-Embedder-Policy "require-corp"
   </IfModule>

   # キャッシュ設定
   <IfModule mod_expires.c>
     ExpiresActive On
     ExpiresByType image/jpg "access plus 1 year"
     ExpiresByType image/jpeg "access plus 1 year"
     ExpiresByType image/png "access plus 1 year"
     ExpiresByType text/css "access plus 1 month"
     ExpiresByType application/javascript "access plus 1 month"
   </IfModule>
   ```

2. **Nginx設定（Nginxの場合）**
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;
       root /path/to/public_html;
       index index.html;

       location / {
           try_files $uri $uri/ /index.html;
       }

       location /_next/static/ {
           add_header Cache-Control "public, max-age=31536000, immutable";
       }

       # セキュリティヘッダー
       add_header Cross-Origin-Opener-Policy "same-origin" always;
       add_header Cross-Origin-Embedder-Policy "require-corp" always;
   }
   ```

### 3.3 Vercelへのデプロイ（推奨）

VercelはNext.jsの開発元が提供するホスティングサービスで、最も簡単にデプロイできます。

#### 3.3.1 セットアップ手順

1. **Vercelアカウントの作成**
   - https://vercel.com にアクセス
   - GitHubアカウントでログイン

2. **プロジェクトのインポート**
   - Dashboardから「New Project」を選択
   - GitHubリポジトリを選択
   - プロジェクト設定を確認

3. **環境変数の設定**
   - Project Settings > Environment Variables
   - `NEXT_PUBLIC_DEVELOPER_MODE=false`を設定
   - `NEXT_TELEMETRY_DISABLED=1`を設定

4. **デプロイ**
   - 「Deploy」ボタンをクリック
   - 自動的にビルドとデプロイが実行されます

5. **カスタムドメインの設定（オプション）**
   - Project Settings > Domains
   - 独自ドメインを追加

#### 3.3.2 メリット

- **自動ビルド**: GitHubへのプッシュで自動デプロイ
- **HTTPS**: 自動でSSL証明書を発行
- **CDN**: グローバルCDNで高速配信
- **無料プラン**: 個人利用であれば無料

### 3.4 Netlifyへのデプロイ

#### 3.4.1 セットアップ手順

1. **Netlifyアカウントの作成**
   - https://www.netlify.com にアクセス

2. **ビルド設定**
   - Build command: `npm run build`
   - Publish directory: `out`（静的エクスポートの場合）または`.next`（SSRの場合）

3. **環境変数の設定**
   - Site settings > Environment variables
   - 必要な環境変数を設定

4. **デプロイ**
   - GitHubリポジトリを連携して自動デプロイ
   - または、手動でビルド済みファイルをアップロード

### 3.5 共有ホスティングでのNode.js実行（Node.js対応サーバーの場合）

一部のレンタルサーバーはNode.jsの実行をサポートしています。

#### 3.5.1 セットアップ手順

1. **SSH接続**
   ```bash
   ssh user@your-server.com
   ```

2. **Node.jsのバージョン確認**
   ```bash
   node --version
   npm --version
   ```

3. **プロジェクトのアップロード**
   - Gitを使用（推奨）:
     ```bash
     git clone https://github.com/kuwa2005/music-waves-visualizer.git
     cd music-waves-visualizer
     ```
   - またはFTP/SFTPでファイルをアップロード

4. **依存関係のインストール**
   ```bash
   npm install --production
   ```

5. **ビルド**
   ```bash
   npm run build
   ```

6. **プロセスマネージャーの設定**
   ```bash
   # PM2を使用（インストールが必要な場合）
   npm install -g pm2
   pm2 start npm --name "music-waves-visualizer" -- start
   pm2 save
   pm2 startup
   ```

## 4. 制限事項と注意点

### 4.1 静的エクスポートの制限

- **SharedArrayBuffer**: 静的エクスポートではCOOP/COEPヘッダーが設定できないため、FFmpeg WebAssemblyの一部機能が制限される可能性があります
- **サーバーサイドレンダリング**: 静的エクスポートではSSR機能は使用できません
- **API Routes**: 静的エクスポートではAPI Routesは使用できません

### 4.2 レンタルサーバーの制限

- **Node.jsバージョン**: サーバーが提供するNode.jsバージョンが古い可能性
- **メモリ制限**: 共有ホスティングではメモリ制限が厳しい場合がある
- **実行時間制限**: 長時間実行される処理が制限される可能性
- **ファイルサイズ制限**: 大きなファイルのアップロードが制限される場合がある

### 4.3 推奨事項

- **Vercel/Netlifyの利用**: Next.jsアプリケーションには専用ホスティングサービスの利用を推奨
- **静的エクスポート**: 可能な限り静的サイトとして配信することで、サーバー負荷を軽減
- **CDNの利用**: 静的ファイルをCDNで配信することで、パフォーマンスを向上

## 5. トラブルシューティング

### 5.1 ビルドエラー

```bash
# キャッシュをクリア
rm -rf .next node_modules
npm install
npm run build
```

### 5.2 パスエラー

- `next.config.js`で`basePath`を設定：
  ```javascript
  const nextConfig = {
    basePath: '/subdirectory',  # サブディレクトリに配置する場合
    output: 'export',
  };
  ```

### 5.3 リソース不足

- ビルド時のメモリ不足を回避：
  ```bash
  NODE_OPTIONS=--max-old-space-size=2048 npm run build
  ```

## 6. セキュリティ設定

### 6.1 HTTPSの有効化

- Let's Encryptなどの無料SSL証明書を利用
- または、ホスティングサービスが提供するSSL証明書を使用

### 6.2 環境変数の管理

- 本番環境では`NEXT_PUBLIC_DEVELOPER_MODE=false`に設定
- 機密情報は環境変数で管理し、Gitにコミットしない

## 7. パフォーマンス最適化

### 7.1 静的ファイルの最適化

- 画像の最適化（Next.js Imageコンポーネントを使用）
- CSS/JavaScriptの圧縮（Next.jsが自動で実行）

### 7.2 キャッシュ設定

- ブラウザキャッシュの設定（.htaccessまたはNginx設定）
- CDNの利用（Vercel、Netlifyは自動でCDNを提供）

## 8. 参考資料

- [Next.js 静的エクスポート](https://nextjs.org/docs/app/building-your-application/deploying/static-exports)
- [Vercel デプロイガイド](https://vercel.com/docs)
- [Netlify デプロイガイド](https://docs.netlify.com/)
- [サーバー要件(local docker)用.md](./サーバー要件(local%20docker)用.md) - ローカル・Docker環境用の詳細情報

